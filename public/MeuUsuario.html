<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meu Perfil</title>

  
  <!-- Fonte Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  
  <link rel="stylesheet" href="MeuUsuário.css" />
</head>
<body>
  <div class="container">
    <header>
      <h1>Meu Perfil</h1>
    </header>


    <!-- Seção de informações -->
    <section class="perfil-section">
      <h2>Informações da conta</h2>
      <div class="perfil-info">
        <div class="foto-perfil">
          <div class="foto" id="foto-preview"></div>
          <button class="btn-alterar-foto" id="btnAlterarFoto"><strong>Alterar foto</strong></button>
          <input type="file" id="inputFoto" accept="image/*" style="display: none;" />
        </div>
        <div class="campos">
    <label>Nome</label>
    <input type="text" id="nomeUsuario" placeholder="Usuário Teste" />
    <label>E-mail</label>
    <input type="email" id="emailUsuario" placeholder="candidato@example.com" disabled />
    <label>Telefone</label>
    <input type="text" id="telefoneUsuario" placeholder="(00) 00000-0000" />
    <label>CEP</label>
    <input type="text" id="cepUsuario" placeholder="00000-000" />
    <label>Endereço</label>
    <input type="text" id="enderecoUsuario" placeholder="Rua, número, bairro..." />
</div>
      </div>
    </section>


    <!-- Seção de alterar senha -->
    <section class="senha-section">
      <h2>Alterar senha</h2>


      <label>Senha atual</label>
      <div class="input-senha">
        <input type="password" id="senhaAtual" placeholder="Digite sua senha atual" />
        <button type="button" class="toggle-senha" data-alvo="senhaAtual">
          <svg class="icone-olho" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
        </button>
      </div>


      <label>Senha nova</label>
      <div class="input-senha">
        <input type="password" id="senhaNova" placeholder="Digite sua nova senha" />
        <button type="button" class="toggle-senha" data-alvo="senhaNova">
          <svg class="icone-olho" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
        </button>
      </div>
      <small id="senhaForcaTexto" class="senha-texto"></small>


      <label>Confirmar nova senha</label>
      <div class="input-senha">
        <input type="password" id="confirmaSenha" placeholder="Confirme sua nova senha" />
        <button type="button" class="toggle-senha" data-alvo="confirmaSenha">
          <svg class="icone-olho" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
        </button>
      </div>
 
      <small id="senhaConfirmaTexto" class="senha-texto"></small>
    </section>

    <section class="favoritos-section">
      <h2>Gerenciar Conta</h2>
      <p class="botao_conta"><a href="Conta/suaconta.html" >Acessar Minhas Configurações</a></p>
    </section>

    <!-- Produtos favoritos -->
    <section class="favoritos-section">
      <h2>Produtos favoritos</h2>
      <ul id="lista-favoritos"></ul>
    </section>


    <!-- Histórico de pedidos -->
    <section class="pedidos-section">
      <h2>Histórico de pedidos</h2>
    </section>


    <!-- Botões -->
    <div class="botoes">
      <button class="btn-primario">Salvar Perfil</button>
      <button class="btn-secundario">Sair</button>
    </div>
  </div>


  <script>
// Em: public/MeuUsuario.html

// --- Variáveis Globais ---
const token = localStorage.getItem('authToken');

// --- Elementos do HTML (Seletores Corrigidos e Mais Robustos) ---
const nomeInput = document.getElementById('nomeUsuario');
const emailInput = document.getElementById('emailUsuario');
const telefoneInput = document.getElementById('telefoneUsuario');
const cepInput = document.getElementById('cepUsuario');
const enderecoInput = document.getElementById('enderecoUsuario');
const fotoPreview = document.getElementById("foto-preview");
const inputFoto = document.getElementById("inputFoto");
const btnAlterarFoto = document.getElementById("btnAlterarFoto");
const senhaAtualInput = document.getElementById('senhaAtual');
const senhaNovaInput = document.getElementById('senhaNova');
const confirmaSenhaInput = document.getElementById('confirmaSenha');
const btnSalvarPerfil = document.querySelector('.btn-primario');
const btnSair = document.querySelector('.btn-secundario');
const listaFavoritosElement = document.getElementById('lista-favoritos');

// O resto do seu script continua exatamente o mesmo...

// --- Funções Principais ---

async function carregarDadosDoPerfil() {
    if (!token) {
        alert('Você não está logado. Redirecionando para a página de login.');
        window.location.href = '/login.cadastro/login.html';
        return;
    }

    try {
        const responsePerfil = await fetch('/api/usuarios/meuperfil', {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!responsePerfil.ok) throw new Error('Falha ao buscar dados do perfil.');
        
        const usuario = await responsePerfil.json();

        nomeInput.value = usuario.nome || '';
        emailInput.value = usuario.email || '';
        telefoneInput.value = usuario.telefone || '';
        cepInput.value = usuario.cep || '';
        enderecoInput.value = usuario.endereco || '';
        if (usuario.fotoUrl) {
            fotoPreview.style.backgroundImage = `url(${usuario.fotoUrl})`;
        }

        await carregarFavoritos();
        
    } catch (error) {
        console.error('Erro:', error);
        if (error.message.includes('token')) {
            logout();
        }
    }
}

async function carregarFavoritos() {
    try {
        const response = await fetch('/api/usuarios/favoritos', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) throw new Error('Falha ao buscar favoritos.');

        const favoritos = await response.json();
        listaFavoritosElement.innerHTML = '';

        if (favoritos.length === 0) {
            listaFavoritosElement.innerHTML = '<li>Você ainda não tem produtos favoritos.</li>';
            return;
        }

        favoritos.forEach(produto => {
            const li = document.createElement('li');
            li.innerHTML = `
                ${produto.nome}
                <button onclick="removerFavorito('${produto._id}')">Remover</button>
            `;
            listaFavoritosElement.appendChild(li);
        });
    } catch (error) {
        console.error('Erro ao carregar favoritos:', error);
    }
}

async function removerFavorito(produtoId) {
    if (!confirm('Tem certeza que deseja remover este produto dos favoritos?')) return;

    try {
        const response = await fetch(`/api/usuarios/favoritos/${produtoId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Falha ao remover favorito.');
        
        alert('Produto removido dos favoritos!');
        await carregarFavoritos();
    } catch (error) {
        console.error('Erro:', error);
        alert(error.message);
    }
}

async function salvarPerfil() {
    const formData = new FormData();
    formData.append('nome', nomeInput.value);
    formData.append('telefone', telefoneInput.value);
    formData.append('cep', cepInput.value);
    formData.append('endereco', enderecoInput.value);

    if (inputFoto.files[0]) {
        formData.append('fotoPerfil', inputFoto.files[0]);
    }

    try {
        const response = await fetch('/api/usuarios/meuperfil', {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.mensagem || 'Erro ao salvar perfil.');

        alert('Perfil atualizado com sucesso!');
        location.reload();

    } catch (error) {
        console.error('Erro:', error);
        alert(error.message);
    }
}

async function alterarSenha() {
     const senhaAtual = senhaAtualInput.value;
     const senhaNova = senhaNovaInput.value;
     const confirmaSenha = confirmaSenhaInput.value;

     if (!senhaAtual || !senhaNova || !confirmaSenha) {
         alert('Por favor, preencha todos os campos de senha.');
         return;
     }

     if (senhaNova !== confirmaSenha) {
         alert('A nova senha e a confirmação não coincidem.');
         return;
     }
     
     try {
         const response = await fetch('/api/usuarios/alterarsenha', {
             method: 'PUT',
             headers: {
                 'Content-Type': 'application/json',
                 'Authorization': `Bearer ${token}`
             },
             body: JSON.stringify({ senhaAtual, senhaNova, confirmaSenha })
         });
         
         const data = await response.json();
         if (!response.ok) throw new Error(data.mensagem || 'Erro ao alterar senha.');

         alert('Senha alterada com sucesso! Você será desconectado por segurança.');
         logout();

     } catch (error) {
         console.error('Erro:', error);
         alert(error.message);
     }
 }

 function logout() {
     localStorage.removeItem('authToken');
     window.location.href = '/login.cadastro/login.html';
 }

 // --- Event Listeners ---
window.addEventListener('DOMContentLoaded', carregarDadosDoPerfil);

btnSalvarPerfil.addEventListener('click', () => {
    // Lógica para decidir qual função chamar
    const camposDeSenhaPreenchidos = senhaAtualInput.value || senhaNovaInput.value || confirmaSenhaInput.value;
    if (camposDeSenhaPreenchidos) {
        alterarSenha();
    } else {
        salvarPerfil();
    }
});

btnSair.addEventListener('click', logout);

btnAlterarFoto.addEventListener("click", () => {
  inputFoto.click();
});

inputFoto.addEventListener("change", () => {
  const file = inputFoto.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      fotoPreview.style.backgroundImage = `url(${e.target.result})`;
    };
    reader.readAsDataURL(file);
  }
});

const svgOlhoAberto = `
<svg class="icone-olho" xmlns="http://www.w3.org/2000/svg" fill="none"
 viewBox="0 0 24 24" stroke="currentColor">
 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
   d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
   d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268
   2.943 9.542 7-1.274 4.057-5.065 7-9.542
   7-4.477 0-8.268-2.943-9.542-7z" />
</svg>
`;

const svgOlhoFechado = `
<svg class="icone-olho" xmlns="http://www.w3.org/2000/svg" fill="none"
 viewBox="0 0 24 24" stroke="currentColor">
 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
   d="M13.875 18.825A10.05 10.05 0 0112 19c-4.477
   0-8.268-2.943-9.542-7a10.05 10.05 0
   012.153-3.592M6.634 6.634A9.956 9.956 0
   0112 5c4.477 0 8.268 2.943 9.542
   7-.458 1.459-1.241 2.763-2.247
   3.802M15 12a3 3 0 01-3 3m0-6a3 3
   0 013 3m-6 0a3 3 0 003-3m0 6v.01" />
 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
   d="M3 3l18 18" />
</svg>
`;

// Alternar mostrar/ocultar senha
document.querySelectorAll(".toggle-senha").forEach(botao => {
  botao.addEventListener("click", () => {
    const campoId = botao.getAttribute("data-alvo");
    const campo = document.getElementById(campoId);

    if (campo.type === "password") {
      campo.type = "text";
      botao.innerHTML = svgOlhoFechado;
    } else {
      campo.type = "password";
      botao.innerHTML = svgOlhoAberto;
    }
  });
});

// Força da senha
function verificarForcaSenha(senha) {
  let forca = 0;
  if (senha.length >= 6) forca++;
  if (/[A-Z]/.test(senha)) forca++;
  if (/[a-z]/.test(senha)) forca++;
  if (/[0-9]/.test(senha)) forca++;
  if (/[@~$!=%*?_&"'-+#¨^:;<>,.{})()]/.test(senha)) forca++;
  return forca;
}

senhaNovaInput.addEventListener("input", () => {
  const valor = senhaNovaInput.value;
  const forca = verificarForcaSenha(valor);

  senhaNovaInput.classList.remove("senha-fraca", "senha-media", "senha-forte");
  senhaTexto.classList.remove("fraca", "media", "forte");
  senhaTexto.textContent = "";

  if (valor.length === 0) return;

  if (forca <= 2) {
    senhaNovaInput.classList.add("senha-fraca");
    senhaTexto.textContent = "Senha fraca";
    senhaTexto.classList.add("fraca");
  } else if (forca === 3 || forca === 4) {
    senhaNovaInput.classList.add("senha-media");
    senhaTexto.textContent = "Senha média";
    senhaTexto.classList.add("media");
  } else if (forca === 5) {
    senhaNovaInput.classList.add("senha-forte");
    senhaTexto.textContent = "Senha forte";
    senhaTexto.classList.add("forte");
  }
});

// Confirmação de senha
function validarConfirmacaoSenha() {
  senhaConfirmaTexto.textContent = "";
  senhaConfirmaTexto.classList.remove("fraca", "forte");
  confirmaSenhaInput.classList.remove("senha-fraca", "senha-forte");

  if (confirmaSenhaInput.value === "") {
    confirmaSenhaInput.style.border = "1px solid #ccc";
    return;
  }

  if (confirmaSenhaInput.value === senhaNovaInput.value) {
    confirmaSenhaInput.classList.add("senha-forte");
    senhaConfirmaTexto.textContent = "Senhas coincidem";
    senhaConfirmaTexto.classList.add("forte");
  } else {
    confirmaSenhaInput.classList.add("senha-fraca");
    senhaConfirmaTexto.textContent = "Senhas não coincidem";
    senhaConfirmaTexto.classList.add("fraca");
  }
}

confirmaSenhaInput.addEventListener("input", validarConfirmacaoSenha);
senhaNovaInput.addEventListener("input", validarConfirmacaoSenha);

    </script>

</body>
</html>
