<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel do Administrador</title>


  <!-- Fonte Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">


  <!-- Ícones Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">


  <link rel="stylesheet" href="PainelADM.css" />
</head>
<body>
  <div class="container">
    <header>
      <h1>Painel do Administrador</h1>
    </header>


    <!-- Seção de informações -->
    <section class="perfil-section">
      <h2>Informações da conta</h2>
      <div class="perfil-info">
        <div class="foto-perfil">
          <div class="foto" id="foto-preview"></div>
          <button class="btn-alterar-foto" id="btnAlterarFoto"><strong>Alterar foto</strong> </button>
          <input type="file" id="inputFoto" accept="image/*" style="display: none;" />
        </div>
        <div class="campos">
          <label>Nome</label>
          <input type="text" placeholder="Administrador" />
          <label>E-mail</label>
          <input type="email" placeholder="admin@example.com" />
          <label>Telefone</label>
          <input type="text" placeholder="(00) 00000-0000" />
          <label>CEP</label>
          <input type="text" placeholder="00000-000" />
          <label>Endereço</label>
          <input type="text" placeholder="Rua, número, bairro..." />
        </div>
      </div>
    </section>


    <!-- Seção de alterar senha -->
    <section class="senha-section">
      <h2>Alterar senha</h2>


      <label>Senha atual</label>
      <div class="input-senha">
        <input type="password" id="senhaAtual" placeholder="Digite sua senha atual" />
        <button type="button" class="toggle-senha" data-alvo="senhaAtual">
          <svg class="icone-olho" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
        </button>
      </div>




      <label>Senha nova</label>
      <div class="input-senha">
        <input type="password" id="senhaNova" placeholder="Digite sua nova senha" />
        <button type="button" class="toggle-senha" data-alvo="senhaNova">
          <svg class="icone-olho" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
        </button>
      </div>
      <small id="senhaForcaTexto" class="senha-texto"></small>


      <label>Confirmar nova senha</label>
      <div class="input-senha">
        <input type="password" id="confirmaSenha" placeholder="Confirme sua nova senha" />
        <button type="button" class="toggle-senha" data-alvo="confirmaSenha">
          <svg class="icone-olho" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
        </button>
      </div>
      <small id="senhaConfirmaTexto" class="senha-texto"></small>
    </section>




    <!-- Gerenciamento de Produtos -->
    <section class="produtos-section">
      <h2>Gerenciamento de Produtos</h2>
      <button class="btn-cadastrar" id="abrirModalProduto">+ Cadastrar Novo Produto</button>


      <table>
        <thead>
          <tr>
            <th>Imagem</th>
            <th>Nome do Produto</th>
            <th>Preço</th>
            <th>Estoque</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="produtos-tabela">
          <!-- Produtos aparecerão aqui -->
        </tbody>
      </table>
    </section>


    <!-- MODAL CADASTRAR/EDITAR -->
    <div class="modal" id="modalProduto">
      <div class="modal-content">
        <span class="fechar" id="fecharModalProduto">&times;</span>
        <h3 id="tituloModalProduto">Cadastrar Novo Produto</h3>
        <form id="formProduto">
          <input type="hidden" id="produtoId">


          <label for="nomeProduto">Nome do Produto</label>
          <input type="text" id="nomeProduto" required>


          <label for="descricaoProduto">Descrição</label>
          <textarea id="descricaoProduto" rows="3" required></textarea>


          <label for="precoProduto">Preço</label>
          <input type="number" id="precoProduto" step="0.01" min="0" required>


          <label for="estoqueProduto">Estoque</label>
          <input type="number" id="estoqueProduto" min="0" required>


          <label for="imagemProduto">Imagem</label>
          <input type="file" id="imagemProduto" accept="image/*">


          <button type="submit" class="btn-primario">Salvar Produto</button>
        </form>
      </div>
    </div>


    <!-- Gerenciamento de Pedidos -->
<section class="pedidos-section">
  <h2>Gerenciamento de Pedidos</h2>
  <table>
    <thead>
      <tr>
        <th>ID do Pedido</th>
        <th>Data</th>
        <th>Cliente</th>
        <th>Valor Total</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="tabela-pedidos">
      <tr>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td>
          <select>
            <option value="processando">Processando</option>
            <option value="enviado">Enviado</option>
            <option value="concluido">Concluído</option>
          </select>
        </td>
      </tr>
    </tbody>
  </table>
</section>


    <tbody id="tabela-pedidos">
      <!-- Preenchido dinamicamente via JS -->
    </tbody>
  </table>
</section>


    <!-- Botões -->
    <div class="botoes">
      <button class="btn-primario">Salvar Perfil</button>
      <button class="btn-secundario">Sair</button>
    </div>
  </div>


  <script>
   // Em: public/PainelADM.html

const token = localStorage.getItem('authToken');

// --- Elementos do Modal de Produto ---
const modalProduto = document.getElementById("modalProduto");
const abrirModalBtn = document.getElementById("abrirModalProduto");
const fecharModalBtn = document.getElementById("fecharModalProduto");
const formProduto = document.getElementById("formProduto");
const tituloModalProduto = document.getElementById("tituloModalProduto");
const produtoIdInput = document.getElementById("produtoId");

// --- Elementos da Tabela de Produtos e Pedidos ---
const tabelaProdutosBody = document.getElementById("produtos-tabela");
const tabelaPedidosBody = document.getElementById("tabela-pedidos");

// --- FUNÇÕES PRINCIPAIS ---

// 1. VERIFICA SE O USUÁRIO É ADMIN E CARREGA OS DADOS INICIAIS
async function verificarAdminEcarregarDados() {
    if (!token) {
        alert('Acesso negado. Faça o login como administrador.');
        window.location.href = '/login.cadastro/login.html';
        return;
    }
    try {
        const response = await fetch('/api/usuarios/meuperfil', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) throw new Error('Falha na autenticação.');
        const usuario = await response.json();
        if (usuario.role !== 'admin') {
            alert('Acesso negado. Esta área é apenas para administradores.');
            window.location.href = '/MeuUsuario.html'; // Redireciona para o perfil normal
            return;
        }
        await carregarProdutos();
        await carregarPedidos();
    } catch (error) {
        console.error('Erro de autorização:', error);
        localStorage.removeItem('authToken');
        window.location.href = '/login.cadastro/login.html';
    }
}

// 2. CARREGA E EXIBE OS PRODUTOS
async function carregarProdutos() {
    try {
        const response = await fetch('/api/produtos'); // Rota pública
        if (!response.ok) throw new Error('Falha ao buscar produtos.');
        const produtos = await response.json();
        tabelaProdutosBody.innerHTML = '';
        produtos.forEach(produto => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><img src="${produto.imagemUrl || 'placeholder.jpg'}" alt="${produto.nome}" style="width: 50px; height: 50px; object-fit: cover;"></td>
                <td>${produto.nome}</td>
                <td>R$ ${produto.preco.toFixed(2)}</td>
                <td>${produto.estoque}</td>
                <td class="acoes">
                    <button class="editar" data-id="${produto._id}"><i class="fas fa-edit"></i></button>
                    <button class="excluir" data-id="${produto._id}"><i class="fas fa-trash"></i></button>
                </td>
            `;
            tabelaProdutosBody.appendChild(tr);
        });
    } catch (error) {
        console.error('Erro ao carregar produtos:', error);
    }
}

// 3. CARREGA E EXIBE OS PEDIDOS
async function carregarPedidos() {
    try {
        const response = await fetch('/api/pedidos', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) throw new Error('Falha ao buscar pedidos.');
        const pedidos = await response.json();
        tabelaPedidosBody.innerHTML = '';
        pedidos.forEach(pedido => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${pedido._id.slice(-6).toUpperCase()}</td>
                <td>${new Date(pedido.dataDoPedido).toLocaleDateString()}</td>
                <td>${pedido.usuario ? pedido.usuario.nome : 'Usuário Deletado'}</td>
                <td>R$ ${pedido.totalDoPedido.toFixed(2)}</td>
                <td>
                    <select class="status-pedido" data-id="${pedido._id}">
                        <option value="Processando" ${pedido.status === 'Processando' ? 'selected' : ''}>Processando</option>
                        <option value="Enviado" ${pedido.status === 'Enviado' ? 'selected' : ''}>Enviado</option>
                        <option value="Entregue" ${pedido.status === 'Entregue' ? 'selected' : ''}>Entregue</option>
                        <option value="Cancelado" ${pedido.status === 'Cancelado' ? 'selected' : ''}>Cancelado</option>
                    </select>
                </td>
            `;
            tabelaPedidosBody.appendChild(tr);
        });
    } catch (error) {
        console.error('Erro ao carregar pedidos:', error);
    }
}

// --- LÓGICA DO MODAL E FORMULÁRIO DE PRODUTOS ---

// Abrir modal para CADASTRAR
abrirModalBtn.addEventListener("click", () => {
    formProduto.reset();
    produtoIdInput.value = '';
    tituloModalProduto.textContent = "Cadastrar Novo Produto";
    modalProduto.style.display = "flex";
});

// Envio do formulário (CRIAR ou EDITAR)
formProduto.addEventListener('submit', async function(e) {
    e.preventDefault();
    const produtoId = produtoIdInput.value;
    const url = produtoId ? `/api/produtos/${produtoId}` : '/api/produtos';
    const method = produtoId ? 'PUT' : 'POST';
    const formData = new FormData(formProduto);
    // Adiciona os campos de texto que não são inputs diretos
    formData.append('nome', document.getElementById('nomeProduto').value);
    formData.append('descricao', document.getElementById('descricaoProduto').value);
    formData.append('preco', document.getElementById('precoProduto').value);
    formData.append('estoque', document.getElementById('estoqueProduto').value);
    formData.append('imagem', document.getElementById('imagemProduto').files[0]);

    try {
        const response = await fetch(url, {
            method: method,
            headers: { 'Authorization': `Bearer ${token}` },
            body: formData
        });
        if (!response.ok) {
             const errData = await response.json();
             throw new Error(errData.mensagem || 'Erro ao salvar produto.');
        }
        alert(`Produto ${produtoId ? 'atualizado' : 'cadastrado'} com sucesso!`);
        modalProduto.style.display = 'none';
        await carregarProdutos();
    } catch (error) {
        console.error('Erro ao salvar produto:', error);
        alert(error.message);
    }
});

// --- DELEGAÇÃO DE EVENTOS PARA AÇÕES NAS TABELAS ---
document.addEventListener('click', async (e) => {
    const target = e.target.closest('button');
    if (!target) return;

    // Ação para EXCLUIR produto
    if (target.classList.contains('excluir')) {
        const id = target.dataset.id;
        if (confirm('Tem certeza que deseja excluir este produto?')) {
            try {
                const response = await fetch(`/api/produtos/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Falha ao excluir produto.');
                alert('Produto excluído com sucesso!');
                await carregarProdutos();
            } catch (error) {
                alert(error.message);
            }
        }
    }
    // Ação para EDITAR produto
    if (target.classList.contains('editar')) {
        const id = target.dataset.id;
        try {
            const response = await fetch(`/api/produtos/${id}`);
            if (!response.ok) throw new Error('Produto não encontrado.');
            const produto = await response.json();
            
            tituloModalProduto.textContent = "Editar Produto";
            produtoIdInput.value = produto._id;
            document.getElementById('nomeProduto').value = produto.nome;
            document.getElementById('descricaoProduto').value = produto.descricao;
            document.getElementById('precoProduto').value = produto.preco;
            document.getElementById('estoqueProduto').value = produto.estoque;
            
            modalProduto.style.display = 'flex';
        } catch (error) {
            alert(error.message);
        }
    }
});

// Ação para MUDAR STATUS do pedido
document.addEventListener('change', async (e) => {
    if (e.target.classList.contains('status-pedido')) {
        const id = e.target.dataset.id;
        const status = e.target.value;
        try {
            const response = await fetch(`/api/pedidos/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ status: status })
            });
            if (!response.ok) throw new Error('Falha ao atualizar status.');
            alert('Status do pedido atualizado!');
        } catch (error) {
            alert(error.message);
            await carregarPedidos();
        }
    }
});

// --- Lógica para fechar o Modal ---
fecharModalBtn.addEventListener("click", () => { modalProduto.style.display = "none"; });
window.addEventListener("click", (e) => { if (e.target === modalProduto) { modalProduto.style.display = "none"; } });

// --- INICIA TUDO ---
window.addEventListener('DOMContentLoaded', verificarAdminEcarregarDados);
  </script>

</body>
</html>
