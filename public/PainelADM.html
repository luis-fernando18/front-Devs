<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel do Administrador</title>


  <!-- Fonte Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">


  <!-- Ícones Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">


  <link rel="stylesheet" href="PainelADM.css" />
</head>
<body>
  <div class="container">
    <header>
      <h1>Painel do Administrador</h1>
    </header>


    <!-- Seção de informações -->
    <section class="perfil-section">
  <h2>Informações da conta</h2>
  <div class="perfil-info">
    <div class="foto-perfil">
      <div class="foto" id="foto-preview"></div>
      <button class="btn-alterar-foto" id="btnAlterarFoto"><strong>Alterar foto</strong> </button>
      <input type="file" id="inputFoto" accept="image/*" style="display: none;" />
    </div>
    <div class="campos">
      <label>Nome</label>
      <input type="text" placeholder="Administrador" id="adminNome" /> <label>E-mail</label>
      <input type="email" placeholder="admin@example.com" id="adminEmail" /> <label>Telefone</label>
      <input type="text" placeholder="(00) 00000-0000" id="adminTelefone" /> <label>CEP</label>
      <input type="text" placeholder="00000-000" id="adminCep" /> <label>Endereço</label>
      <input type="text" placeholder="Rua, número, bairro..." id="adminEndereco" /> </div>
  </div>
</section>


    <!-- Seção de alterar senha -->
    <section class="senha-section">
      <h2>Alterar senha</h2>


      <label>Senha atual</label>
      <div class="input-senha">
        <input type="password" id="senhaAtual" placeholder="Digite sua senha atual" />
        <button type="button" class="toggle-senha" data-alvo="senhaAtual">
          <svg class="icone-olho" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
        </button>
      </div>




      <label>Senha nova</label>
      <div class="input-senha">
        <input type="password" id="senhaNova" placeholder="Digite sua nova senha" />
        <button type="button" class="toggle-senha" data-alvo="senhaNova">
          <svg class="icone-olho" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
        </button>
      </div>
      <small id="senhaForcaTexto" class="senha-texto"></small>


      <label>Confirmar nova senha</label>
      <div class="input-senha">
        <input type="password" id="confirmaSenha" placeholder="Confirme sua nova senha" />
        <button type="button" class="toggle-senha" data-alvo="confirmaSenha">
          <svg class="icone-olho" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
        </button>
      </div>
      <small id="senhaConfirmaTexto" class="senha-texto"></small>
    </section>




    <!-- Gerenciamento de Produtos -->
    <section class="produtos-section">
      <h2>Gerenciamento de Produtos</h2>
      <button class="btn-cadastrar" id="abrirModalProduto">+ Cadastrar Novo Produto</button>


      <table>
        <thead>
          <tr>
            <th>Imagem</th>
            <th>Nome do Produto</th>
            <th>Preço</th>
            <th>Estoque</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="produtos-tabela">
          <!-- Produtos aparecerão aqui -->
        </tbody>
      </table>
    </section>


    <!-- MODAL CADASTRAR/EDITAR -->
    <div class="modal" id="modalProduto">
      <div class="modal-content">
        <span class="fechar" id="fecharModalProduto">&times;</span>
        <h3 id="tituloModalProduto">Cadastrar Novo Produto</h3>
        <form id="formProduto">
          <input type="hidden" id="produtoId">


          <label for="nomeProduto">Nome do Produto</label>
          <input type="text" id="nomeProduto" required>


          <label for="descricaoProduto">Descrição</label>
          <textarea id="descricaoProduto" rows="3" required></textarea>


          <label for="precoProduto">Preço</label>
          <input type="number" id="precoProduto" step="0.01" min="0" required>


          <label for="estoqueProduto">Estoque</label>
          <input type="number" id="estoqueProduto" min="0" required>


          <label for="imagemProduto">Imagem</label>
          <input type="file" id="imagemProduto" accept="image/*">


          <button type="submit" class="btn-primario">Salvar Produto</button>
        </form>
      </div>
    </div>


    <!-- Gerenciamento de Pedidos -->
<section class="pedidos-section">
  <h2>Gerenciamento de Pedidos</h2>
  <table>
    <thead>
      <tr>
        <th>ID do Pedido</th>
        <th>Data</th>
        <th>Cliente</th>
        <th>Valor Total</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="tabela-pedidos">
      <tr>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td>
          <select>
            <option value="processando">Processando</option>
            <option value="enviado">Enviado</option>
            <option value="concluido">Concluído</option>
          </select>
        </td>
      </tr>
    </tbody>
  </table>
</section>


    <tbody id="tabela-pedidos">
      <!-- Preenchido dinamicamente via JS -->
    </tbody>
  </table>
</section>


    <!-- Botões -->

<div class="botoes">
  <button id="btnSalvarPerfil">Salvar Perfil</button>
  <button id="btnSair">Sair</button>
</div>

  <script>
   // Em: public/PainelADM.html

const token = localStorage.getItem('authToken');

// --- Elementos do Modal de Produto ---
const modalProduto = document.getElementById("modalProduto");
const abrirModalBtn = document.getElementById("abrirModalProduto");
const fecharModalBtn = document.getElementById("fecharModalProduto");
const formProduto = document.getElementById("formProduto");
const tituloModalProduto = document.getElementById("tituloModalProduto");
const produtoIdInput = document.getElementById("produtoId");

// --- Elementos da Tabela de Produtos e Pedidos ---
const tabelaProdutosBody = document.getElementById("produtos-tabela");
const tabelaPedidosBody = document.getElementById("tabela-pedidos");

  const inputNome = document.getElementById('adminNome');
  const inputEmail = document.getElementById('adminEmail');
  const inputTelefone = document.getElementById('adminTelefone');
  const inputCep = document.getElementById('adminCep');
  const inputEndereco = document.getElementById('adminEndereco');
  const inputFotoPreview = document.getElementById('foto-preview');
  const inputFotoFile = document.getElementById('inputFoto');

  // --- FUNÇÕES PRINCIPAIS ---

// 1. VERIFICA SE O USUÁRIO É ADMIN E CARREGA OS DADOS INICIAIS
async function verificarAdminEcarregarDados() {

    if (!token) {
        alert('Acesso negado. Faça o login como administrador.');
        window.location.href = '/login.cadastro/login.html';
        return;
    }
    try {
        const response = await fetch('/api/usuarios/meuperfil', {
            headers: { 'Authorization': `Bearer ${token}` }
        }); //
        if (!response.ok) throw new Error('Falha na autenticação.');
        const usuario = await response.json();
        if (usuario.role !== 'admin') {
            alert('Acesso negado. Esta área é apenas para administradores.');
            window.location.href = '/MeuUsuario.html'; // Redireciona para o perfil normal
            return;
        }

        inputNome.value = usuario.nome || '';
        inputEmail.value = usuario.email || '';
        inputTelefone.value = usuario.telefone || '';
        inputCep.value = usuario.cep || '';
        inputEndereco.value = usuario.endereco || '';
        if (usuario.fotoUrl) {
            inputFotoPreview.style.backgroundImage = `url(${usuario.fotoUrl})`;
        }

        await carregarProdutos();
        await carregarPedidos();
    } catch (error) {
        console.error('Erro de autorização:', error);
        localStorage.removeItem('authToken');
        window.location.href = '/login.cadastro/login.html';
    }


}

// 2. CARREGA E EXIBE OS PRODUTOS
async function carregarProdutos() {
    try {
        const response = await fetch('/api/produtos'); // Rota pública
        if (!response.ok) throw new Error('Falha ao buscar produtos.');
        const produtos = await response.json();
        tabelaProdutosBody.innerHTML = '';
        produtos.forEach(produto => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><img src="${produto.imagemUrl || 'placeholder.jpg'}" alt="${produto.nome}" style="width: 50px; height: 50px; object-fit: cover;"></td>
                <td>${produto.nome}</td>
                <td>R$ ${produto.preco.toFixed(2)}</td>
                <td>${produto.estoque}</td>
                <td class="acoes">
                    <button class="editar" data-id="${produto._id}"><i class="fas fa-edit"></i></button>
                    <button class="excluir" data-id="${produto._id}"><i class="fas fa-trash"></i></button>
                </td>
            `;
            tabelaProdutosBody.appendChild(tr);
        });
    } catch (error) {
        console.error('Erro ao carregar produtos:', error);
    }
}

// 3. CARREGA E EXIBE OS PEDIDOS
async function carregarPedidos() {
    try {
        const response = await fetch('/api/pedidos', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) throw new Error('Falha ao buscar pedidos.');
        const pedidos = await response.json();
        tabelaPedidosBody.innerHTML = '';
        pedidos.forEach(pedido => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${pedido._id.slice(-6).toUpperCase()}</td>
                <td>${new Date(pedido.dataDoPedido).toLocaleDateString()}</td>
                <td>${pedido.usuario ? pedido.usuario.nome : 'Usuário Deletado'}</td>
                <td>R$ ${pedido.totalDoPedido.toFixed(2)}</td>
                <td>
                    <select class="status-pedido" data-id="${pedido._id}">
                        <option value="Processando" ${pedido.status === 'Processando' ? 'selected' : ''}>Processando</option>
                        <option value="Enviado" ${pedido.status === 'Enviado' ? 'selected' : ''}>Enviado</option>
                        <option value="Entregue" ${pedido.status === 'Entregue' ? 'selected' : ''}>Entregue</option>
                        <option value="Cancelado" ${pedido.status === 'Cancelado' ? 'selected' : ''}>Cancelado</option>
                    </select>
                </td>
            `;
            tabelaPedidosBody.appendChild(tr);
        });
    } catch (error) {
        console.error('Erro ao carregar pedidos:', error);
    }
}

// --- LÓGICA DO MODAL E FORMULÁRIO DE PRODUTOS ---

// Abrir modal para CADASTRAR
abrirModalBtn.addEventListener("click", () => {
    formProduto.reset();
    produtoIdInput.value = '';
    tituloModalProduto.textContent = "Cadastrar Novo Produto";
    modalProduto.style.display = "flex";
});

// Envio do formulário (CRIAR ou EDITAR)
formProduto.addEventListener('submit', async function(e) {
    e.preventDefault();
    const produtoId = produtoIdInput.value;
    const url = produtoId ? `/api/produtos/${produtoId}` : '/api/produtos';
    const method = produtoId ? 'PUT' : 'POST';
    const formData = new FormData(formProduto);
    // Adiciona os campos de texto que não são inputs diretos
    formData.append('nome', document.getElementById('nomeProduto').value);
    formData.append('descricao', document.getElementById('descricaoProduto').value);
    formData.append('preco', document.getElementById('precoProduto').value);
    formData.append('estoque', document.getElementById('estoqueProduto').value);
    formData.append('imagem', document.getElementById('imagemProduto').files[0]);

    try {
        const response = await fetch(url, {
            method: method,
            headers: { 'Authorization': `Bearer ${token}` },
            body: formData
        });
        if (!response.ok) {
             const errData = await response.json();
             throw new Error(errData.mensagem || 'Erro ao salvar produto.');
        }
        alert(`Produto ${produtoId ? 'atualizado' : 'cadastrado'} com sucesso!`);
        modalProduto.style.display = 'none';
        await carregarProdutos();
    } catch (error) {
        console.error('Erro ao salvar produto:', error);
        alert(error.message);
    }
});

// --- DELEGAÇÃO DE EVENTOS PARA AÇÕES NAS TABELAS ---
document.addEventListener('click', async (e) => {
    const target = e.target.closest('button');
    if (!target) return;

    // Ação para EXCLUIR produto
    if (target.classList.contains('excluir')) {
        const id = target.dataset.id;
        if (confirm('Tem certeza que deseja excluir este produto?')) {
            try {
                const response = await fetch(`/api/produtos/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Falha ao excluir produto.');
                alert('Produto excluído com sucesso!');
                await carregarProdutos();
            } catch (error) {
                alert(error.message);
            }
        }
    }
    // Ação para EDITAR produto
    if (target.classList.contains('editar')) {
        const id = target.dataset.id;
        try {
            const response = await fetch(`/api/produtos/${id}`);
            if (!response.ok) throw new Error('Produto não encontrado.');
            const produto = await response.json();
            
            tituloModalProduto.textContent = "Editar Produto";
            produtoIdInput.value = produto._id;
            document.getElementById('nomeProduto').value = produto.nome;
            document.getElementById('descricaoProduto').value = produto.descricao;
            document.getElementById('precoProduto').value = produto.preco;
            document.getElementById('estoqueProduto').value = produto.estoque;
            
            modalProduto.style.display = 'flex';
        } catch (error) {
            alert(error.message);
        }
    }
});

// Ação para MUDAR STATUS do pedido
document.addEventListener('change', async (e) => {
    if (e.target.classList.contains('status-pedido')) {
        const id = e.target.dataset.id;
        const status = e.target.value;
        try {
            const response = await fetch(`/api/pedidos/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ status: status })
            });
            if (!response.ok) throw new Error('Falha ao atualizar status.');
            alert('Status do pedido atualizado!');
        } catch (error) {
            alert(error.message);
            await carregarPedidos();
        }
    }
});

// --- Lógica para fechar o Modal ---
fecharModalBtn.addEventListener("click", () => { modalProduto.style.display = "none"; });
window.addEventListener("click", (e) => { if (e.target === modalProduto) { modalProduto.style.display = "none"; } });

// --- Novas Funções para Salvar Perfil e Logout ---

// Função para Salvar Perfil (Problema 2)
async function salvarPerfilAdmin(event) {
    event.preventDefault(); // Prevenir envio padrão se estiver dentro de um form

    // 1. Coletar dados dos inputs
    const dadosFormulario = new FormData();
    dadosFormulario.append('nome', inputNome.value);
    dadosFormulario.append('email', inputEmail.value);
    dadosFormulario.append('telefone', inputTelefone.value);
    dadosFormulario.append('cep', inputCep.value);
    dadosFormulario.append('endereco', inputEndereco.value);

    // 2. Verificar se uma nova foto foi selecionada
    if (inputFotoFile.files[0]) {
        dadosFormulario.append('fotoPerfil', inputFotoFile.files[0]);
    }

    // 3. Enviar para o backend (a rota PUT /api/usuarios/meuperfil já existe e está correta)
    try {
        const response = await fetch('/api/usuarios/meuperfil', {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`
                // Não defina 'Content-Type' ao usar FormData, o navegador faz isso automaticamente.
            },
            body: dadosFormulario
        });

        const resultado = await response.json();

        if (!response.ok) {
            throw new Error(resultado.mensagem || 'Erro ao salvar perfil.');
        }

        alert('Perfil atualizado com sucesso!');
        // Opcional: recarregar os dados para exibir a nova foto se foi alterada
        // location.reload();

    } catch (error) {
        console.error('Erro ao salvar perfil:', error);
        alert(error.message);
    }
}

// Função de Logout (Problema 3)
function fazerLogout() {
    console.log("Saindo...");
    localStorage.removeItem('authToken'); // (baseado na lógica de verificação)
    window.location.href = '/login.cadastro/login.html'; // (baseado na lógica de redirecionamento)
}

  window.addEventListener('DOMContentLoaded', () => {


    verificarAdminEcarregarDados();

    // Selecionar os botões e adicionar os listeners
    const btnSalvar = document.getElementById('btnSalvarPerfil');
    const btnSair = document.getElementById('btnSair');

    console.log("Botão Salvar encontrado:", btnSalvar);
    console.log("Botão Sair encontrado:", btnSair);

    if (btnSalvar) {
        btnSalvar.addEventListener('click', salvarPerfilAdmin);
    }
    if (btnSair) {
        btnSair.addEventListener('click', fazerLogout);
    }

    // Listener para o input de foto (bônus, para ligar o botão de alterar foto ao input escondido)
    const btnAlterarFoto = document.getElementById('btnAlterarFoto');
    if(btnAlterarFoto) {
        btnAlterarFoto.addEventListener('click', () => {
            inputFotoFile.click(); // Clica no input de arquivo escondido
        });
        // Mostrar preview da imagem selecionada antes do upload
        inputFotoFile.addEventListener('change', () => {
            if (inputFotoFile.files && inputFotoFile.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    inputFotoPreview.style.backgroundImage = `url(${e.target.result})`;
                };
                reader.readAsDataURL(inputFotoFile.files[0]);
            }
        });
    }
});


//  Funções extras para senha
const senhaTexto = document.getElementById("senhaForcaTexto");
const senhaConfirmaTexto = document.getElementById("senhaConfirmaTexto");

// Alternar mostrar/ocultar senha
document.querySelectorAll(".toggle-senha").forEach(botao => {
  botao.addEventListener("click", () => {
    const campoId = botao.getAttribute("data-alvo");
    const campo = document.getElementById(campoId);
    const icone = botao.querySelector("svg path:last-child");

    if (campo.type === "password") {
      campo.type = "text";
      icone.setAttribute("d", "M3 3l18 18M13.875 18.825A10.05 10.05 0 0112 19c-4.477 0-8.268-2.943-9.542-7a10.05 10.05 0 012.153-3.592M6.634 6.634A9.956 9.956 0 0112 5c4.477 0 8.268 2.943 9.542 7-.458 1.459-1.241 2.763-2.247 3.802");
    } else {
      campo.type = "password";
      icone.setAttribute("d", "M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z");
    }
  });
});

// Força da senha
function verificarForcaSenha(senha) {
  let forca = 0;
  if (senha.length >= 6) forca++;
  if (/[A-Z]/.test(senha)) forca++;
  if (/[a-z]/.test(senha)) forca++;
  if (/[0-9]/.test(senha)) forca++;
  if (/[@~$!=%*?_&"'-+#¨^:;<>,.{})()]/.test(senha)) forca++;
  return forca;
}

senhaNovaInput.addEventListener("input", () => {
  const valor = senhaNovaInput.value;
  const forca = verificarForcaSenha(valor);

  senhaNovaInput.classList.remove("senha-fraca", "senha-media", "senha-forte");
  senhaTexto.classList.remove("fraca", "media", "forte");
  senhaTexto.textContent = "";

  if (valor.length === 0) return;

  if (forca <= 2) {
    senhaNovaInput.classList.add("senha-fraca");
    senhaTexto.textContent = "Senha fraca";
    senhaTexto.classList.add("fraca");
  } else if (forca === 3 || forca === 4) {
    senhaNovaInput.classList.add("senha-media");
    senhaTexto.textContent = "Senha média";
    senhaTexto.classList.add("media");
  } else if (forca === 5) {
    senhaNovaInput.classList.add("senha-forte");
    senhaTexto.textContent = "Senha forte";
    senhaTexto.classList.add("forte");
  }
});

// Confirmação de senha
function validarConfirmacaoSenha() {
  senhaConfirmaTexto.textContent = "";
  senhaConfirmaTexto.classList.remove("fraca", "forte");
  confirmaSenhaInput.classList.remove("senha-fraca", "senha-forte");

  if (confirmaSenhaInput.value === "") {
    confirmaSenhaInput.style.border = "1px solid #ccc";
    return;
  }

  if (confirmaSenhaInput.value === senhaNovaInput.value) {
    confirmaSenhaInput.classList.add("senha-forte");
    senhaConfirmaTexto.textContent = "Senhas coincidem";
    senhaConfirmaTexto.classList.add("forte");
  } else {
    confirmaSenhaInput.classList.add("senha-fraca");
    senhaConfirmaTexto.textContent = "Senhas não coincidem";
    senhaConfirmaTexto.classList.add("fraca");
  }
}

confirmaSenhaInput.addEventListener("input", validarConfirmacaoSenha);
senhaNovaInput.addEventListener("input", validarConfirmacaoSenha);
  </script>

</body>
</html>
